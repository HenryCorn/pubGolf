---
import BaseLayout from '../layouts/BaseLayout.astro';
import GlassCard from '../components/GlassCard.astro';
import { supabase } from '../lib/supabase';
import { calculateHoleScore, calculateTotalScore, calculateAverageScore, getBestAndWorstScores, calculatePenaltiesAndBonuses } from '../utils/score';
import type { PlayerWithScores } from '../types/database';

// Fetch all data
const { data: players } = await supabase.from('players').select('*');
const { data: pubs } = await supabase.from('pubs').select('*').order('order_index');
const { data: scores } = await supabase.from('scores').select('*');

// Process players with scores
const playersWithScores: PlayerWithScores[] = (players || []).map(player => {
  const playerScores = (scores || []).filter(s => s.player_id === player.id);
  return {
    ...player,
    scores: playerScores,
    totalScore: calculateTotalScore(playerScores)
  };
});

const pubsList = pubs || [];

// Calculate key metrics
const totalPlayers = playersWithScores.length;
const holesCompleted = playersWithScores.reduce((sum, p) => sum + p.scores.length, 0);
const avgScore = totalPlayers > 0 ? (playersWithScores.reduce((sum, p) => sum + p.totalScore, 0) / totalPlayers).toFixed(1) : '0';
const bestScore = totalPlayers > 0 ? Math.min(...playersWithScores.map(p => p.totalScore)) : 0;
---

<BaseLayout title="Tournament Statistics - PUB GOLF VOL.4 - THE XMAS ONE">
  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8 pb-24 bg-gradient-to-br from-forest to-green-800 min-h-screen">
    <!-- Header -->
    <section class="mb-8">
      <GlassCard dark={true} class="text-center">
        <h1 class="font-display text-3xl font-bold mb-2 text-white">ðŸŽ„ Tournament Analytics</h1>
        <p class="text-gray-300">Deep insights into player performance, pub statistics, and Christmas tournament trends</p>
        <div class="flex items-center justify-center mt-4">
          <div class="w-3 h-3 bg-amber rounded-full mr-2"></div>
          <span class="text-sm text-white">Live Data Analysis - Nov 14, 2025</span>
        </div>
      </GlassCard>
    </section>

    <!-- Key Metrics -->
    <section class="mb-8">
      <div class="grid md:grid-cols-4 gap-6">
        <div class="metric-card rounded-2xl p-6 text-center text-white">
          <div class="text-3xl font-bold text-amber mb-2">{totalPlayers}</div>
          <div class="text-sm text-gray-300">Active Players</div>
        </div>
        <div class="metric-card rounded-2xl p-6 text-center text-white">
          <div class="text-3xl font-bold text-amber mb-2">{holesCompleted}</div>
          <div class="text-sm text-gray-300">Holes Completed</div>
        </div>
        <div class="metric-card rounded-2xl p-6 text-center text-white">
          <div class="text-3xl font-bold text-amber mb-2">{avgScore}</div>
          <div class="text-sm text-gray-300">Average Score</div>
        </div>
        <div class="metric-card rounded-2xl p-6 text-center text-white">
          <div class="text-3xl font-bold text-amber mb-2">{bestScore}</div>
          <div class="text-sm text-gray-300">Best Score</div>
        </div>
      </div>
    </section>

    <!-- Performance Overview Chart -->
    <section class="mb-8">
      <GlassCard dark={true}>
        <div class="flex items-center justify-between mb-6">
          <h2 class="font-display text-2xl font-bold text-white">Performance Overview</h2>
          <div class="flex gap-2">
            <button class="filter-btn active px-4 py-2 rounded-lg text-white text-sm font-medium transition-all" data-view="all">All Players</button>
            <button class="filter-btn px-4 py-2 rounded-lg glass text-white text-sm font-medium transition-all" data-view="top3">Top 3</button>
          </div>
        </div>
        <div id="overview-chart" class="min-h-[400px]"></div>
      </GlassCard>
    </section>

    <!-- Player Statistics Table -->
    <section class="mb-8">
      <GlassCard dark={true}>
        <h2 class="font-display text-2xl font-bold mb-6 text-white">Detailed Statistics</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-white">
            <thead>
              <tr class="border-b border-white/20">
                <th class="text-left py-3 px-4">Player</th>
                <th class="text-left py-3 px-4">Total Score</th>
                <th class="text-left py-3 px-4">Avg per Hole</th>
                <th class="text-left py-3 px-4">Best Hole</th>
                <th class="text-left py-3 px-4">Worst Hole</th>
                <th class="text-left py-3 px-4">Penalties</th>
                <th class="text-left py-3 px-4">Bonuses</th>
              </tr>
            </thead>
            <tbody>
              {playersWithScores.map(player => {
                const avgPerHole = calculateAverageScore(player.scores);
                const { best, worst } = getBestAndWorstScores(player.scores);
                const { penalties, bonuses } = calculatePenaltiesAndBonuses(player.scores);
                const scoreColor = player.totalScore < 10 ? 'text-green-400' : player.totalScore < 20 ? 'text-amber' : 'text-red-400';
                
                return (
                  <tr class="border-b border-white/10 hover:bg-white/5 transition-colors">
                    <td class="py-3 px-4">
                      <div class="flex items-center space-x-3">
                        <span class="text-lg">{player.avatar}</span>
                        <div>
                          <div class="font-semibold">{player.name}</div>
                          <div class="text-xs text-gray-400">#{player.id.slice(0, 8)}</div>
                        </div>
                      </div>
                    </td>
                    <td class="py-3 px-4">
                      <span class={`font-bold ${scoreColor}`}>{player.totalScore}</span>
                    </td>
                    <td class="py-3 px-4">{avgPerHole}</td>
                    <td class="py-3 px-4">
                      <span class="text-green-400 font-bold">{best}</span>
                    </td>
                    <td class="py-3 px-4">
                      <span class="text-red-400 font-bold">{worst}</span>
                    </td>
                    <td class="py-3 px-4">{penalties}</td>
                    <td class="py-3 px-4">{bonuses}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </GlassCard>
    </section>

    <!-- Pub Performance Analysis -->
    <section class="mb-8">
      <GlassCard dark={true}>
        <h2 class="font-display text-2xl font-bold mb-6 text-white">Pub Performance Analysis</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <h3 class="font-semibold mb-4 text-white">Average Scores by Pub</h3>
            <div id="pub-scores-chart" class="min-h-[400px]"></div>
          </div>
          <div>
            <h3 class="font-semibold mb-4 text-white">Difficulty Ranking</h3>
            <div id="difficulty-chart" class="min-h-[400px]"></div>
          </div>
        </div>
      </GlassCard>
    </section>
  </main>

  <script define:vars={{ players: playersWithScores, pubs: pubsList }}>
    let charts = {};
    let currentView = 'all';
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeCharts();
      initializeFilters();
      initializeAnimations();
    });
    
    function initializeCharts() {
      if (!window.echarts) return;
      
      charts.overview = window.echarts.init(document.getElementById('overview-chart'));
      charts.pubScores = window.echarts.init(document.getElementById('pub-scores-chart'));
      charts.difficulty = window.echarts.init(document.getElementById('difficulty-chart'));
      
      updateOverviewChart();
      updatePubScoresChart();
      updateDifficultyChart();
    }
    
    function updateOverviewChart() {
      if (!charts.overview) return;
      
      let displayPlayers = currentView === 'top3' 
        ? [...players].sort((a, b) => a.totalScore - b.totalScore).slice(0, 3)
        : players;
      
      const series = displayPlayers.map(player => ({
        name: player.name.split(' ').pop(),
        type: 'line',
        data: pubs.map(pub => {
          const score = player.scores.find(s => s.pub_id === pub.id);
          return score ? score.sips + score.penalties - score.bonuses : null;
        }),
        smooth: true,
        symbol: 'circle',
        symbolSize: 8,
        lineStyle: { width: 3 }
      }));
      
      const option = {
        title: {
          text: currentView === 'top3' ? 'Top 3 Players Performance' : 'All Players Performance',
          left: 'center',
          textStyle: { color: '#FFFFFF', fontSize: 16 }
        },
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          borderColor: '#F77F00',
          textStyle: { color: '#FFFFFF' }
        },
        legend: {
          bottom: 10,
          textStyle: { color: '#FFFFFF' }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '15%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: pubs.map(pub => pub.name.split(' ')[0]),
          axisLabel: { color: '#FFFFFF', rotate: 45 }
        },
        yAxis: {
          type: 'value',
          name: 'Score',
          nameTextStyle: { color: '#FFFFFF' },
          axisLabel: { color: '#FFFFFF' }
        },
        series: series,
        color: ['#F77F00', '#FFD700', '#1B4332', '#2D5A3D', '#8B4513', '#4682B4']
      };
      
      charts.overview.setOption(option);
    }
    
    function updatePubScoresChart() {
      if (!charts.pubScores) return;
      
      const pubData = pubs.map(pub => {
        const scores = players.flatMap(player => {
          const score = player.scores.find(s => s.pub_id === pub.id);
          return score ? [score.sips + score.penalties - score.bonuses] : [];
        });
        const avgScore = scores.length > 0 
          ? scores.reduce((sum, s) => sum + s, 0) / scores.length 
          : 0;
        return { name: pub.name.split(' ')[0], value: avgScore.toFixed(1) };
      });
      
      const option = {
        title: {
          text: 'Average Scores by Pub',
          left: 'center',
          textStyle: { color: '#FFFFFF', fontSize: 14 }
        },
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          borderColor: '#F77F00',
          textStyle: { color: '#FFFFFF' }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '10%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: pubData.map(item => item.name),
          axisLabel: { color: '#FFFFFF', rotate: 45 }
        },
        yAxis: {
          type: 'value',
          name: 'Avg Score',
          nameTextStyle: { color: '#FFFFFF' },
          axisLabel: { color: '#FFFFFF' }
        },
        series: [{
          type: 'bar',
          data: pubData.map(item => parseFloat(item.value)),
          itemStyle: {
            color: '#F77F00',
            borderRadius: [4, 4, 0, 0]
          }
        }]
      };
      
      charts.pubScores.setOption(option);
    }
    
    function updateDifficultyChart() {
      if (!charts.difficulty) return;
      
      const difficultyData = pubs.map(pub => {
        const scores = players.flatMap(player => {
          const score = player.scores.find(s => s.pub_id === pub.id);
          return score ? [score.sips + score.penalties - score.bonuses] : [];
        });
        const avgScore = scores.length > 0 
          ? scores.reduce((sum, s) => sum + s, 0) / scores.length 
          : 0;
        return { name: pub.name, value: avgScore };
      }).sort((a, b) => b.value - a.value);
      
      const option = {
        title: {
          text: 'Pub Difficulty Ranking',
          left: 'center',
          textStyle: { color: '#FFFFFF', fontSize: 14 }
        },
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          borderColor: '#F77F00',
          textStyle: { color: '#FFFFFF' }
        },
        series: [{
          type: 'pie',
          radius: ['40%', '70%'],
          data: difficultyData.map((item, index) => ({
            name: `${index + 1}. ${item.name}`,
            value: item.value.toFixed(1)
          })),
          itemStyle: {
            borderRadius: 8,
            borderColor: '#fff',
            borderWidth: 2
          },
          label: {
            color: '#FFFFFF',
            fontSize: 12
          }
        }],
        color: ['#F77F00', '#FFD700', '#1B4332', '#2D5A3D', '#8B4513', '#4682B4', '#DC143C']
      };
      
      charts.difficulty.setOption(option);
    }
    
    function initializeFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active', 'bg-amber'));
          this.classList.add('active', 'bg-amber');
          currentView = this.dataset.view;
          updateOverviewChart();
        });
      });
    }
    
    function initializeAnimations() {
      if (!window.anime) return;
      
      window.anime({
        targets: '.metric-card',
        scale: [0.9, 1],
        opacity: [0, 1],
        duration: 600,
        delay: window.anime.stagger(100),
        easing: 'easeOutQuart'
      });
    }
    
    window.addEventListener('resize', () => {
      Object.values(charts).forEach(chart => {
        if (chart && chart.resize) chart.resize();
      });
    });
  </script>
</BaseLayout>

<style>
  .metric-card {
    background: linear-gradient(135deg, rgba(247, 127, 0, 0.1), rgba(255, 215, 0, 0.1));
    border: 1px solid rgba(247, 127, 0, 0.3);
  }
  
  .filter-btn.active {
    background: #F77F00;
    color: white;
  }
</style>
